<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Evades Enhanced</title>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background: #111; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; }
        canvas { display: none; background: #222; cursor: none; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.95); z-index: 10; text-align: center; padding: 20px; }
        .hidden { display: none !important; }

        #uiOverlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height:100%; pointer-events: none; z-index: 5; padding: 15px; }

        #topLeftUI { position: absolute; top: 15px; left: 15px; pointer-events: all; }
        #gameInfo { font-size: 18px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius:5px; margin-bottom: 10px; }
        #scoreDisplay, #lobbyLevelDisplay { margin-bottom: 5px; } /* Renamed levelDisplay */

        #chatContainer { width: 300px; height: 200px; background: rgba(30,30,30,0.7); padding: 8px; display: flex; flex-direction: column; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        #chatMessages { flex-grow: 1; overflow-y: auto; margin-bottom: 8px; font-size: 13px; color: #e0e0e0; scroll-behavior: smooth; }
        #chatMessages div { margin-bottom: 4px; line-height: 1.4; }
        #chatMessages .own-message { color: #aaffaa; font-weight: bold;}
        #chatMessages .system-message { color: #88aaff; font-style: italic;}
        #chatInput { width: 100%; padding: 8px; background: #444; color: white; border: 1px solid #666; border-radius: 3px; font-size: 14px; pointer-events: all; }

        #leaderboardContainer { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.5); padding:10px; border-radius:5px; font-size:14px; max-height: calc(100vh - 30px); overflow-y:auto; pointer-events:all; min-width:220px; }
        #leaderboardContainer h3 { margin:0 0 10px 0; font-size:18px; text-align:center; color: #ddd;}
        #leaderboardContainer ul { list-style:none; padding:0; margin:0; }
        #leaderboardContainer li { margin-bottom:5px; padding: 3px 5px; border-radius: 3px; }
        .dead-player { text-decoration: line-through; color: #aaa !important; opacity: 0.7; }
        .leaderboard-self { font-weight: bold; background-color: rgba(255,255,255,0.1); }


        #lobbyNameDisplay { position:absolute; top:15px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.6); padding:5px 15px; border-radius:5px; font-size:18px; }
        h2 { font-size: 36px; margin-bottom: 20px; color: #eee; }
        input[type="text"], input[type="password"] { padding: 10px 15px; font-size: 20px; margin-bottom: 15px; width: 280px; text-align: center; border: 2px solid #555; background-color: #333; color: white; border-radius: 5px; }
        .menuButton { padding: 15px 30px; font-size: 24px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 8px; transition: background 0.3s, transform 0.1s; margin-top: 15px; box-shadow: 0 4px #999; min-width: 180px; display: block; margin-left: auto; margin-right: auto; }
        .menuButton:hover:not(:disabled) { background: #45a049; }
        .menuButton:active:not(:disabled) { background-color: #3e8e41; box-shadow: 0 2px #666; transform: translateY(3px); }
        .menuButton:disabled { background-color: #555; color: #aaa; cursor: not-allowed; box-shadow: 0 4px #666; }
        .secondaryButton { background-color: #007bff; }
        .secondaryButton:hover:not(:disabled) { background-color: #0056b3; }
        .secondaryButton:active:not(:disabled) { background-color: #004085; }
        .smallButton { padding: 8px 15px; font-size: 16px; min-width: 100px; margin-top: 10px; }
        .inline-label { display: inline-block; width: 90px; text-align: right; margin-right: 10px; font-size: 16px; }
        .error-message { color: #ff4444; margin-top: 10px; height: 1.2em; font-size: 14px; }
        .info-message { color: #aaa; font-size: 14px; }
        #usernameScreen {}
        #mouseToggleInfo { margin-top:15px; color:#bbb; font-size:14px; }
        #respawnMessage { background:rgba(200,0,0,0.8); color:white; padding:15px 20px; border-radius:8px; font-size:18px; text-align:center; z-index:20; display:none; white-space:pre-wrap; max-width:80%; margin-top:20px; }
        #lobbyBrowserScreen { justify-content:flex-start; padding-top:5vh; }
        #lobbyListContainer { width:80%; max-width:700px; height:60vh; background:rgba(255,255,255,0.05); border-radius:8px; overflow-y:auto; padding:15px; margin-bottom:20px; border:1px solid #444; }
        #lobbyListTable { width:100%; border-collapse:collapse; }
        #lobbyListTable th, #lobbyListTable td { padding:10px 12px; text-align:left; border-bottom:1px solid #444; }
        #lobbyListTable th { font-size:16px; color:#ccc; }
        #lobbyListTable tr:last-child td { border-bottom:none; }
        #lobbyListTable tr:hover:not(.no-hover) { background:rgba(255,255,255,0.1); cursor:pointer; }
        .no-hover { background:inherit!important; cursor:default!important; }
        .lobby-passworded::after { content:' ðŸ”’'; color:gold; font-size:0.8em; vertical-align:middle; }
        #lobbyActions { display:flex; justify-content:center; gap:20px; margin-top:10px; }
        #createLobbyScreen {}
        .form-row { margin-bottom:15px; }
        #passwordPrompt { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(40,40,40,0.98); padding:30px 40px; border-radius:10px; z-index:50; box-shadow:0 5px 25px rgba(0,0,0,0.5); border:1px solid #666; display:none; }
        #passwordPrompt h3 { margin:0 0 20px 0; font-size:22px; }
        #customCursor { position:absolute; width:10px; height:10px; background:rgba(255,255,255,0.7); border-radius:50%; border:1px solid white; pointer-events:none; z-index:100; transform:translate(-50%,-50%); display:none; }
    </style>
</head>
<body>
    <!-- Screens -->
    <div id="usernameScreen" class="screen">
        <h2>Evades Enhanced</h2>
        <input type="text" id="usernameInput" placeholder="Username" maxlength="16">
        <button id="connectBtn" class="menuButton">CONNECT</button>
        <p id="mouseToggleInfo">(WASD/Arrows or Mouse to Move)<br />Press 'M' in-game to toggle mouse control.</p>
        <div id="respawnMessage"></div>
        <div id="connectionStatus" class="info-message" style="margin-top: 10px;"></div>
    </div>

    <div id="lobbyBrowserScreen" class="screen hidden">
        <h2>Lobby Browser</h2>
        <div id="lobbyListContainer">
            <table id="lobbyListTable">
                <thead><tr class="no-hover"><th>Name</th><th>Players</th><th>Password</th><th>Action</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="lobbyActions">
            <button id="refreshLobbiesBtn" class="menuButton secondaryButton smallButton">Refresh</button>
            <button id="showCreateLobbyBtn" class="menuButton smallButton">Create Lobby</button>
        </div>
        <div id="lobbyError" class="error-message"></div>
    </div>

    <div id="createLobbyScreen" class="screen hidden">
        <h2>Create New Lobby</h2>
        <div class="form-row">
            <label for="newLobbyNameInput" class="inline-label">Lobby Name:</label>
            <input type="text" id="newLobbyNameInput" placeholder="Lobby Name (max 30 chars)" maxlength="30">
        </div>
        <div class="form-row">
            <label for="newLobbyPasswordInput" class="inline-label">Password:</label>
            <input type="password" id="newLobbyPasswordInput" placeholder="(Optional - max 20 chars)" maxlength="20">
        </div>
        <div id="createLobbyError" class="error-message"></div>
        <div>
            <button id="createLobbySubmitBtn" class="menuButton smallButton">Create</button>
            <button id="cancelCreateLobbyBtn" class="menuButton secondaryButton smallButton">Cancel</button>
        </div>
    </div>

    <!-- In-Game UI Elements -->
    <div id="uiOverlay" class="hidden">
        <div id="lobbyNameDisplay">Lobby: ---</div>

        <div id="topLeftUI">
            <div id="gameInfo">
                <div id="scoreDisplay">Score: 0</div>
                <div id="lobbyLevelDisplay">Lobby Lvl: 1</div>
                <div id="playerLevelDisplay">My Lvl: 1 (XP: 0/100)</div>
            </div>
            <div id="chatContainer">
                <div id="chatMessages"></div>
                <input type="text" id="chatInput" placeholder="Press Enter to chat">
            </div>
        </div>

        <div id="leaderboardContainer">
            <h3>Leaderboard</h3>
            <ul id="leaderboardList"></ul>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>
    <div id="customCursor"></div>

    <!-- Password Prompt Modal -->
    <div id="passwordPrompt">
        <h3 id="passwordPromptTitle">Enter Password for Lobby:</h3>
        <input type="password" id="passwordInput" placeholder="Password">
        <div id="passwordError" class="error-message"></div>
        <div>
            <button id="passwordSubmitBtn" class="menuButton smallButton">Join</button>
            <button id="passwordCancelBtn" class="menuButton secondaryButton smallButton">Cancel</button>
        </div>
    </div>

<script>
(function() {
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const uiOverlay = document.getElementById('uiOverlay');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const lobbyLevelDisplay = document.getElementById('lobbyLevelDisplay'); // Renamed
    const playerLevelDisplay = document.getElementById('playerLevelDisplay');
    const leaderboardListUl = document.getElementById('leaderboardList');
    const lobbyNameDisplay = document.getElementById('lobbyNameDisplay');

    const chatContainer = document.getElementById('chatContainer');
    const chatMessagesDiv = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');

    const usernameScreen = document.getElementById('usernameScreen');
    const usernameInput = document.getElementById('usernameInput');
    const connectBtn = document.getElementById('connectBtn');
    const respawnMessageDiv = document.getElementById('respawnMessage');
    const connectionStatus = document.getElementById('connectionStatus');
    const lobbyBrowserScreen = document.getElementById('lobbyBrowserScreen');
    const lobbyListTableBody = document.getElementById('lobbyListTable').querySelector('tbody');
    const refreshLobbiesBtn = document.getElementById('refreshLobbiesBtn');
    const showCreateLobbyBtn = document.getElementById('showCreateLobbyBtn');
    const lobbyError = document.getElementById('lobbyError');
    const createLobbyScreen = document.getElementById('createLobbyScreen');
    const newLobbyNameInput = document.getElementById('newLobbyNameInput');
    const newLobbyPasswordInput = document.getElementById('newLobbyPasswordInput');
    const createLobbySubmitBtn = document.getElementById('createLobbySubmitBtn');
    const cancelCreateLobbyBtn = document.getElementById('cancelCreateLobbyBtn');
    const createLobbyError = document.getElementById('createLobbyError');
    const passwordPrompt = document.getElementById('passwordPrompt');
    const passwordPromptTitle = document.getElementById('passwordPromptTitle');
    const passwordInputEle = document.getElementById('passwordInput'); // Renamed to avoid conflict
    const passwordSubmitBtn = document.getElementById('passwordSubmitBtn');
    const passwordCancelBtn = document.getElementById('passwordCancelBtn');
    const passwordError = document.getElementById('passwordError');
    const customCursor = document.getElementById('customCursor');

    let ws = null;
    let currentScreen = 'username';
    let myPlayerId = null;
    let currentLobbyId = null;
    let currentLobbyName = null;
    let players = {};
    let obstacles = [];
    let currentLobbyLevel = 1;
    let currentScore = 0;
    let myPlayerLevel = 1;
    let myPlayerXp = 0;
    let myPlayerXpNeeded = 100; // Initial
    let safeZoneWidthRatio = 0.2; // Should match server

    let inputIntervalId = null;
    let animationFrameId = null;
    let gameActive = false;
    let useMouseControl = false;
    const keys = {};
    let clientMousePos = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
    const inputSendInterval = 1000 / 45; // ~22ms, for ~45Hz updates
    let lastSentInputTime = 0;
    let lobbyToJoin = null;

    function showScreen(screenName) {
        usernameScreen.classList.add('hidden');
        lobbyBrowserScreen.classList.add('hidden');
        createLobbyScreen.classList.add('hidden');
        uiOverlay.classList.add('hidden');
        canvas.style.display = 'none';
        customCursor.style.display = 'none';
        passwordPrompt.style.display = 'none';
        chatContainer.style.display = 'none'; // Hide chat by default

        currentScreen = screenName;
        lobbyError.textContent = '';
        createLobbyError.textContent = '';
        passwordError.textContent = '';

        switch (screenName) {
            case 'username': usernameScreen.classList.remove('hidden'); usernameInput.focus(); break;
            case 'lobbyBrowser': lobbyBrowserScreen.classList.remove('hidden'); sendMessage({ type: 'getLobbies' }); break;
            case 'createLobby': createLobbyScreen.classList.remove('hidden'); newLobbyNameInput.focus(); break;
            case 'inGame':
                uiOverlay.classList.remove('hidden');
                chatContainer.style.display = 'flex'; // Show chat in game
                canvas.style.display = 'block';
                resizeCanvas();
                customCursor.style.display = useMouseControl ? 'block' : 'none'; // Show cursor only if mouse control active
                chatInput.blur(); // Ensure chat isn't focused on game start
                break;
        }
    }

    function sendMessage(data) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            try { ws.send(JSON.stringify(data)); } catch (error) { console.error("WS Send Error:", data, error); }
        } else {
            console.warn("WS not open, cannot send:", data);
            setStatusMessage("Connection lost.", true);
        }
    }

    function setStatusMessage(message, isError = false) {
        connectionStatus.textContent = message;
        connectionStatus.style.color = isError ? '#ff4444' : '#aaa';
    }

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', () => { if (currentScreen === 'inGame') { resizeCanvas(); } });

    function connectWebSocket(username) {
        respawnMessageDiv.style.display = 'none';
        connectBtn.disabled = true; usernameInput.disabled = true;
        setStatusMessage("Connecting...");
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}`; // Simpler URL construct
        ws = new WebSocket(wsUrl);
        gameActive = false;

        ws.onopen = () => { setStatusMessage("Connected. Loading lobbies..."); showScreen('lobbyBrowser'); };
        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                handleServerMessage(data);
            } catch (error) { console.error('WS Message Parse Error:', event.data, error); }
        };
        ws.onerror = (error) => {
            console.error('WebSocket Error:', error);
            if (!gameActive && !respawnMessageDiv.textContent.includes('Died recently')) {
                setStatusMessage("Connection error. Check server.", true);
            }
            shutdownClient();
        };
        ws.onclose = (event) => {
            console.log(`WebSocket closed. Code: ${event.code}, Reason: ${event.reason}`);
            if (event.code !== 1008 || !respawnMessageDiv.textContent.includes('Died recently')) {
                //setStatusMessage("Disconnected.", true); // Can be annoying if intended close
            }
            shutdownClient();
        };
    }

    function handleServerMessage(data) {
        switch (data.type) {
            case 'lobbyList': if (currentScreen === 'lobbyBrowser') { populateLobbyList(data.lobbies); } break;
            case 'joinSuccess':
                console.log(`Joined lobby: ${data.lobbyName} (${data.lobbyId})`);
                currentLobbyId = data.lobbyId; currentLobbyName = data.lobbyName;
                lobbyNameDisplay.textContent = `Lobby: ${currentLobbyName}`;
                myPlayerId = data.playerId;
                sendMessage({ type: 'setUsername', username: usernameInput.value.trim() || `Player_${myPlayerId.substring(0, 4)}` });

                if (data.initialState) {
                    players = data.initialState.players || {};
                    obstacles = data.initialState.obstacles || [];
                    currentLobbyLevel = data.initialState.lobbyLevel || 1;
                    currentScore = data.initialState.score || 0;
                    safeZoneWidthRatio = data.initialState.safeZoneWidthRatio || 0.2;
                    // Update my player specific level from initial state
                    if (players[myPlayerId]) {
                        myPlayerLevel = players[myPlayerId].level || 1;
                        myPlayerXp = players[myPlayerId].xp || 0;
                        myPlayerXpNeeded = players[myPlayerId].xpNeeded || 100;
                    }
                } else { players = {}; obstacles = []; currentLobbyLevel = 1; currentScore = 0; }
                updateUI();
                showScreen('inGame');
                if (!gameActive) { gameActive = true; requestAnimationFrame(gameLoop); }
                if (!inputIntervalId) { inputIntervalId = setInterval(sendInput, inputSendInterval); }
                break;
            case 'createFailed':
                console.error("Lobby creation failed:", data.reason);
                if (currentScreen === 'createLobby') createLobbyError.textContent = data.reason || "Failed.";
                else lobbyError.textContent = data.reason || "Failed.";
                break;
            case 'joinFailed':
                console.error("Lobby join failed:", data.reason);
                if (passwordPrompt.style.display === 'block') passwordError.textContent = data.reason || "Failed.";
                else lobbyError.textContent = data.reason || "Failed.";
                lobbyToJoin = null;
                break;
            case 'passwordRequired':
                lobbyToJoin = data.lobbyId;
                const row = lobbyListTableBody.querySelector(`tr[data-lobby-id="${data.lobbyId}"]`);
                const lname = row ? row.dataset.lobbyName : data.lobbyId;
                passwordPromptTitle.textContent = `Enter Password for: ${lname}`;
                passwordInputEle.value = ''; passwordError.textContent = '';
                passwordPrompt.style.display = 'block'; passwordInputEle.focus();
                break;
            case 'respawnTimeout':
                console.log(`Respawn timeout: ${data.timeLeft}s left.`);
                respawnMessageDiv.textContent = `Died recently! Respawn in ${data.timeLeft}s.`;
                respawnMessageDiv.style.display = 'block';
                showScreen('username'); // Go back to username screen
                break;
            case 'gameState':
                if (currentScreen === 'inGame') {
                    players = data.players || {};
                    obstacles = data.obstacles || [];
                    if (data.lobbyLevel !== currentLobbyLevel) currentLobbyLevel = data.lobbyLevel;
                    if (data.score !== currentScore) currentScore = data.score;
                    if (players[myPlayerId]) { // Update my specific level info
                        myPlayerLevel = players[myPlayerId].level;
                        myPlayerXp = players[myPlayerId].xp;
                        myPlayerXpNeeded = players[myPlayerId].xpNeeded;
                    }
                    updateUI();
                }
                break;
            case 'lobbyLevelUp': // Server's main level up
                console.log(`Lobby Level Up to ${data.newLobbyLevel}`);
                currentLobbyLevel = data.newLobbyLevel;
                addChatMessage(`Lobby advanced to Level ${currentLobbyLevel}! Difficulty increased.`, null, true);
                updateUI();
                break;
            case 'playerLeveledUp': // Individual player leveled up (could be self or other)
                if (data.playerId === myPlayerId) {
                    myPlayerLevel = data.newLevel;
                    myPlayerXp = 0; // Reset XP, server should also send new xpNeeded
                    myPlayerXpNeeded = data.xpNeeded;
                    addChatMessage(`You reached Level ${myPlayerLevel}!`, null, true);
                } else if (players[data.playerId]) {
                     addChatMessage(`${players[data.playerId].username} reached Level ${data.newLevel}!`, null, true);
                }
                updateUI(); // This will refresh leaderboard
                break;
            case 'chatMessage':
                addChatMessage(data.message, data.username, false, data.playerId === myPlayerId);
                break;

        }
    }
    function addChatMessage(message, username = "System", isSystem = true, isSelf = false) {
        const messageElement = document.createElement('div');
        if (isSystem) {
            messageElement.classList.add('system-message');
            messageElement.textContent = message;
        } else {
            if (isSelf) messageElement.classList.add('own-message');
            messageElement.textContent = `${username}: ${message}`;
        }
        chatMessagesDiv.appendChild(messageElement);
        chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    }


    function shutdownClient() {
        console.log("Shutting down client state...");
        gameActive = false;
        if (ws) { ws.onclose = null; ws.onerror = null; ws.onmessage = null; ws.onopen = null; if (ws.readyState < 2) ws.close(); ws = null; }
        if (inputIntervalId) { clearInterval(inputIntervalId); inputIntervalId = null; }
        if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
        myPlayerId = null; currentLobbyId = null; currentLobbyName = null;
        players = {}; obstacles = []; currentLobbyLevel = 1; currentScore = 0; myPlayerLevel = 1; myPlayerXp = 0; myPlayerXpNeeded = 100;
        keys = {}; useMouseControl = false; lobbyToJoin = null;
        showScreen('username');
        canvas.style.cursor = 'default'; customCursor.style.display = 'none';
        connectBtn.disabled = false; usernameInput.disabled = false;
        lobbyListTableBody.innerHTML = '';
        chatMessagesDiv.innerHTML = ''; // Clear chat
        updateUI();
        if (respawnMessageDiv.style.display === 'none' && currentScreen === 'username') { // Only if not already showing respawn message
             setStatusMessage("Disconnected.");
        }
    }

    function populateLobbyList(lobbyData) {
        lobbyListTableBody.innerHTML = '';
        if (!lobbyData || lobbyData.length === 0) {
            lobbyListTableBody.innerHTML = '<tr class="no-hover"><td colspan="4" style="text-align: center; color: #aaa;">No lobbies found. Create one!</td></tr>';
            return;
        }
        lobbyError.textContent = '';
        lobbyData.sort((a, b) => a.name.localeCompare(b.name)).forEach(lobby => {
            const row = document.createElement('tr');
            row.dataset.lobbyId = lobby.id; row.dataset.lobbyName = lobby.name; row.dataset.passwordProtected = lobby.passwordProtected;
            const nameCell = document.createElement('td'); nameCell.textContent = lobby.name; if (lobby.passwordProtected) nameCell.classList.add('lobby-passworded');
            const playersCell = document.createElement('td'); playersCell.textContent = `${lobby.playerCount}`;
            const passwordCell = document.createElement('td'); passwordCell.textContent = lobby.passwordProtected ? 'Yes' : 'No';
            const actionCell = document.createElement('td');
            const joinBtn = document.createElement('button'); joinBtn.textContent = 'Join'; joinBtn.classList.add('menuButton', 'smallButton', 'secondaryButton');
            joinBtn.onclick = (e) => { e.stopPropagation(); attemptJoinLobby(lobby.id, lobby.name, lobby.passwordProtected); };
            actionCell.appendChild(joinBtn);
            row.appendChild(nameCell); row.appendChild(playersCell); row.appendChild(passwordCell); row.appendChild(actionCell);
            row.onclick = () => { attemptJoinLobby(lobby.id, lobby.name, lobby.passwordProtected); };
            lobbyListTableBody.appendChild(row);
        });
    }

    function attemptJoinLobby(lobbyId, lobbyName, isPasswordProtected) {
        lobbyError.textContent = '';
        if (isPasswordProtected) {
            lobbyToJoin = lobbyId;
            passwordPromptTitle.textContent = `Enter Password for: ${lobbyName}`;
            passwordInputEle.value = ''; passwordError.textContent = '';
            passwordPrompt.style.display = 'block'; passwordInputEle.focus();
        } else {
            sendMessage({ type: 'joinLobby', lobbyId: lobbyId });
        }
    }

    document.addEventListener('keydown', (e) => {
        if (document.activeElement === chatInput) {
             if (e.key === 'Escape') chatInput.blur();
            return; // Don't process game keys if typing in chat
        }
        const key = e.key.toLowerCase();
        keys[key] = true;
        if (key === 'm' && currentScreen === 'inGame') {
            useMouseControl = !useMouseControl;
            customCursor.style.display = useMouseControl ? 'block' : 'none';
            sendInput(true); // Force send mouse toggle
        }
         if (key === 'enter' && currentScreen === 'inGame' && document.activeElement !== chatInput) {
            chatInput.focus();
            e.preventDefault(); // Prevent default enter behavior if any
        }
    });
    document.addEventListener('keyup', (e) => {
        if (document.activeElement === chatInput) return;
        keys[e.key.toLowerCase()] = false;
    });
    document.addEventListener('mousemove', (e) => {
        if (currentScreen === 'inGame') {
            const rect = canvas.getBoundingClientRect();
            clientMousePos.x = e.clientX - rect.left;
            clientMousePos.y = e.clientY - rect.top;
            customCursor.style.left = `${e.clientX}px`;
            customCursor.style.top = `${e.clientY}px`;
        }
    });
    canvas.addEventListener('mouseenter', () => { if (currentScreen === 'inGame' && useMouseControl) customCursor.style.display = 'block'; });
    canvas.addEventListener('mouseleave', () => { if (currentScreen === 'inGame') customCursor.style.display = 'none'; });
    canvas.addEventListener('contextmenu', (e) => e.preventDefault());

    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (message) {
                sendMessage({ type: 'chat', message: message });
            }
            chatInput.value = '';
            // chatInput.blur(); // Optionally blur after sending
        }
    });


    function sendInput(forceSend = false) {
        if (!ws || ws.readyState !== WebSocket.OPEN || !myPlayerId || currentScreen !== 'inGame') return;
        const now = Date.now();
        if (!forceSend && now - lastSentInputTime < inputSendInterval * 0.9) return; // Throttle

        const inputData = { type: 'input', useMouse: useMouseControl };
        if (useMouseControl) {
            inputData.mousePos = { x: clientMousePos.x, y: clientMousePos.y };
        } else {
            const activeKeys = {};
            for (const key in keys) { if (keys[key]) activeKeys[key] = true; }
            inputData.keys = activeKeys;
        }
        sendMessage(inputData);
        lastSentInputTime = now;
    }

    function drawPlayer(player) {
        if (!player) return;
        ctx.save();
        ctx.lineWidth = 1;
        if (!player.isAlive) {
            ctx.globalAlpha = 0.4; ctx.fillStyle = '#AAAAAA'; ctx.strokeStyle = 'black';
        } else {
            ctx.globalAlpha = 1.0; ctx.fillStyle = player.color || 'white'; ctx.strokeStyle = 'black';
        }
        ctx.beginPath();
        ctx.arc(player.x, player.y, player.size || 15, 0, Math.PI * 2);
        ctx.fill();
        if (player.id === myPlayerId) { ctx.strokeStyle = 'white'; ctx.lineWidth = 2; }
        ctx.stroke();

        ctx.fillStyle = player.isAlive ? 'white' : '#ddd';
        ctx.font = '10px Segoe UI'; ctx.textAlign = 'center';
        if (typeof player.x === 'number' && typeof player.y === 'number') {
            const nameTag = `L${player.level} ${player.username || `P ${player.id.substring(0,2)}`}`;
            ctx.fillText(nameTag, player.x, player.y - (player.size || 15) - 5);
        }
        ctx.restore();
    }

    function drawObstacle(obstacle) {
        if (!obstacle) return;
        ctx.fillStyle = obstacle.color || '#ff4444';
        ctx.beginPath();
        const radius = obstacle.size / 2; // Assuming size is diameter
        if (typeof obstacle.x === 'number' && typeof obstacle.y === 'number' && radius > 0) {
            ctx.arc(obstacle.x, obstacle.y, radius, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    function drawSafeZone() {
        const safeZoneActualWidth = canvas.width * safeZoneWidthRatio;
        ctx.save();
        ctx.fillStyle = 'rgba(80, 180, 80, 0.15)'; // Light green, semi-transparent
        ctx.fillRect(0, 0, safeZoneActualWidth, canvas.height);
        ctx.strokeStyle = 'rgba(80, 180, 80, 0.4)';
        ctx.lineWidth = 2;
        ctx.strokeRect(0, 0, safeZoneActualWidth, canvas.height);
        ctx.restore();
    }


    function updateUI() {
        if (scoreDisplay) scoreDisplay.textContent = `Score: ${currentScore}`;
        if (lobbyLevelDisplay) lobbyLevelDisplay.textContent = `Lobby Lvl: ${currentLobbyLevel}`;
        if (playerLevelDisplay) playerLevelDisplay.textContent = `My Lvl: ${myPlayerLevel} (XP: ${myPlayerXp}/${myPlayerXpNeeded})`;
        updateLeaderboardDisplay();
    }

    function updateLeaderboardDisplay() {
        if (!leaderboardListUl) return;
        leaderboardListUl.innerHTML = '';

        const sortedPlayers = Object.values(players)
            .filter(p => p && typeof p.level === 'number')
            .sort((a, b) => {
                if (b.level !== a.level) return b.level - a.level; // Sort by level desc
                if (b.xp !== a.xp) return b.xp - a.xp; // Then by XP desc
                return (a.username || '').localeCompare(b.username || ''); // Then by name asc
            });

        sortedPlayers.forEach(player => {
            const li = document.createElement('li');
            li.style.color = player.color || 'white';
            let text = `Lvl ${player.level} - ${player.username || `Player ${player.id.substring(0,4)}`}`;
             if (!player.isAlive) {
                li.classList.add('dead-player');
                text += " (KIA)";
            }
            if (player.id === myPlayerId) {
                li.classList.add('leaderboard-self');
                // text += ' (You)'; // Already clear by style
            }
            li.textContent = text;
            leaderboardListUl.appendChild(li);
        });
    }


    function gameLoop(timestamp) {
        if (!gameActive || currentScreen !== 'inGame') { animationFrameId = null; return; }

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawSafeZone(); // Draw safe zone first
        obstacles.forEach(drawObstacle);
        Object.values(players).forEach(drawPlayer);

        animationFrameId = requestAnimationFrame(gameLoop);
    }

    // --- Event Listeners ---
    connectBtn.addEventListener('click', () => {
        const username = usernameInput.value.trim();
        connectWebSocket(username || `Player${Math.floor(Math.random() * 1000)}`);
    });
    usernameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') connectBtn.click(); });
    refreshLobbiesBtn.addEventListener('click', () => { lobbyError.textContent = ''; sendMessage({ type: 'getLobbies' }); });
    showCreateLobbyBtn.addEventListener('click', () => {
        newLobbyNameInput.value = ''; newLobbyPasswordInput.value = '';
        createLobbyError.textContent = ''; showScreen('createLobby');
    });
    cancelCreateLobbyBtn.addEventListener('click', () => { showScreen('lobbyBrowser'); });
    createLobbySubmitBtn.addEventListener('click', () => {
        const name = newLobbyNameInput.value.trim();
        const pass = newLobbyPasswordInput.value;
        createLobbyError.textContent = '';
        if (!name) { createLobbyError.textContent = 'Lobby name is required.'; return; }
        sendMessage({ type: 'createLobby', lobbyName: name, password: pass || null });
    });
    passwordCancelBtn.addEventListener('click', () => { passwordPrompt.style.display = 'none'; lobbyToJoin = null; });
    passwordSubmitBtn.addEventListener('click', () => {
        if (lobbyToJoin) {
            const pass = passwordInputEle.value;
            passwordError.textContent = '';
            sendMessage({ type: 'joinLobby', lobbyId: lobbyToJoin, password: pass });
            passwordPrompt.style.display = 'none';
        }
    });
    passwordInputEle.addEventListener('keypress', (e) => { if (e.key === 'Enter') passwordSubmitBtn.click(); });

    // --- Initial Setup ---
    showScreen('username');
    setStatusMessage("Ready to connect.");

})();
</script>
</body>
</html>
