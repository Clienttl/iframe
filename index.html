<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multiplayer Dodge - Lobbies</title>
    <style>
        /* --- Styles (UNCHANGED from previous version) --- */
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background: #111; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; }
        canvas { display: none; background: #222; cursor: none; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.95); z-index: 10; text-align: center; padding: 20px; }
        .hidden { display: none !important; }

        /* UI Overlay (In-Game) */
        #uiOverlay { display: flex; position: absolute; top: 0; left: 0; width: 100%; pointer-events: none; z-index: 5; padding: 15px; justify-content: space-between; align-items: flex-start; }
        #gameInfo { font-size: 20px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; }
        #scoreDisplay, #levelDisplay { margin-bottom: 5px; }
        #playerList { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px; font-size: 14px; max-height: 200px; overflow-y: auto; pointer-events: all; min-width: 150px; }
        #playerList h3 { margin: 0 0 5px 0; font-size: 16px; text-align: center; }
        #playerList ul { list-style: none; padding: 0; margin: 0; }
        #playerList li { margin-bottom: 3px; }
        .dead-player { text-decoration: line-through; color: #aaa; }
        #lobbyNameDisplay { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 5px; font-size: 18px; }

        /* Shared Styles */
         h2 { font-size: 36px; margin-bottom: 20px; color: #eee; }
        input[type="text"], input[type="password"] { padding: 10px 15px; font-size: 20px; margin-bottom: 15px; width: 280px; text-align: center; border: 2px solid #555; background-color: #333; color: white; border-radius: 5px; }
        .menuButton { padding: 15px 30px; font-size: 24px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 8px; transition: background 0.3s, transform 0.1s; margin-top: 15px; box-shadow: 0 4px #999; min-width: 180px; display: block; margin-left: auto; margin-right: auto;}
        .menuButton:hover:not(:disabled) { background: #45a049; }
        .menuButton:active:not(:disabled) { background-color: #3e8e41; box-shadow: 0 2px #666; transform: translateY(3px); }
        .menuButton:disabled { background-color: #555; color: #aaa; cursor: not-allowed; box-shadow: 0 4px #666;}
        .secondaryButton { background-color: #007bff; }
        .secondaryButton:hover:not(:disabled) { background-color: #0056b3; }
        .secondaryButton:active:not(:disabled) { background-color: #004085; }
        .smallButton { padding: 8px 15px; font-size: 16px; min-width: 100px; margin-top: 10px;}
        .inline-label { display: inline-block; width: 90px; text-align: right; margin-right: 10px; font-size: 16px;}
        .error-message { color: #ff4444; margin-top: 10px; height: 1.2em; font-size: 14px; }
        .info-message { color: #aaa; font-size: 14px; }

        /* Username Screen */
        #usernameScreen {}
        #mouseToggleInfo { margin-top: 15px; color: #bbb; font-size: 14px;}
        #respawnMessage { background: rgba(200, 0, 0, 0.8); color: white; padding: 15px 20px; border-radius: 8px; font-size: 18px; text-align: center; z-index: 20; display: none; white-space: pre-wrap; max-width: 80%; margin-top: 20px;}

        /* Lobby Browser Screen */
        #lobbyBrowserScreen { justify-content: flex-start; padding-top: 5vh; }
        #lobbyListContainer { width: 80%; max-width: 700px; height: 60vh; background: rgba(255, 255, 255, 0.05); border-radius: 8px; overflow-y: auto; padding: 15px; margin-bottom: 20px; border: 1px solid #444;}
        #lobbyListTable { width: 100%; border-collapse: collapse; }
        #lobbyListTable th, #lobbyListTable td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #444; }
        #lobbyListTable th { font-size: 16px; color: #ccc; }
        #lobbyListTable tr:last-child td { border-bottom: none; }
        #lobbyListTable tr:hover { background: rgba(255, 255, 255, 0.1); cursor: pointer; }
        .lobby-passworded::after { content: ' ðŸ”’'; color: gold; font-size: 0.8em; vertical-align: middle; }
        #lobbyActions { display: flex; justify-content: center; gap: 20px; margin-top: 10px; }

        /* Create Lobby Screen */
        #createLobbyScreen { }
        .form-row { margin-bottom: 15px; }

        /* Password Prompt */
        #passwordPrompt { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(40, 40, 40, 0.98); padding: 30px 40px; border-radius: 10px; z-index: 50; box-shadow: 0 5px 25px rgba(0,0,0,0.5); border: 1px solid #666; display: none; }
        #passwordPrompt h3 { margin: 0 0 20px 0; font-size: 22px; }

        /* Custom Cursor */
        #customCursor { position: absolute; width: 10px; height: 10px; background: rgba(255, 255, 255, 0.7); border-radius: 50%; border: 1px solid white; pointer-events: none; z-index: 100; transform: translate(-50%, -50%); display: none; }
    </style>
</head>
<body>

    <!-- Screens -->
    <div id="usernameScreen" class="screen">
        <h2>Enter Your Username</h2>
        <input type="text" id="usernameInput" placeholder="Username" maxlength="16">
        <button id="connectBtn" class="menuButton">CONNECT</button>
        <p id="mouseToggleInfo">
            (WASD/Arrows or Mouse to Move)<br/>
            Press 'M' in-game to toggle mouse control.
        </p>
         <div id="respawnMessage"></div>
         <div id="connectionStatus" class="info-message" style="margin-top: 10px;"></div>
    </div>

    <div id="lobbyBrowserScreen" class="screen hidden">
        <h2>Lobby Browser</h2>
        <div id="lobbyListContainer">
            <table id="lobbyListTable">
                <thead>
                    <tr><th>Name</th><th>Players</th><th>Password</th><th>Action</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div id="lobbyActions">
            <button id="refreshLobbiesBtn" class="menuButton secondaryButton smallButton">Refresh</button>
            <button id="showCreateLobbyBtn" class="menuButton smallButton">Create Lobby</button>
        </div>
         <div id="lobbyError" class="error-message"></div>
    </div>

    <div id="createLobbyScreen" class="screen hidden">
        <h2>Create New Lobby</h2>
        <div class="form-row">
             <label for="newLobbyNameInput" class="inline-label">Lobby Name:</label>
             <input type="text" id="newLobbyNameInput" placeholder="Lobby Name (max 30 chars)" maxlength="30">
        </div>
        <div class="form-row">
             <label for="newLobbyPasswordInput" class="inline-label">Password:</label>
             <input type="password" id="newLobbyPasswordInput" placeholder="(Optional - max 20 chars)" maxlength="20">
        </div>
        <div id="createLobbyError" class="error-message"></div>
        <div>
            <button id="createLobbySubmitBtn" class="menuButton smallButton">Create</button>
            <button id="cancelCreateLobbyBtn" class="menuButton secondaryButton smallButton">Cancel</button>
        </div>
    </div>

    <!-- In-Game UI Elements -->
    <div id="uiOverlay" class="hidden">
         <div id="lobbyNameDisplay">Lobby: ---</div>
        <div id="gameInfo">
            <div id="scoreDisplay">Score: 0</div>
            <div id="levelDisplay">Level: 1</div>
        </div>
        <div id="playerList">
            <h3>Players</h3>
            <ul id="players"></ul>
        </div>
    </div>
    <canvas id="gameCanvas"></canvas>
    <div id="customCursor"></div>

    <!-- Password Prompt Modal -->
    <div id="passwordPrompt">
         <h3 id="passwordPromptTitle">Enter Password for Lobby:</h3>
         <input type="password" id="passwordInput" placeholder="Password">
         <div id="passwordError" class="error-message"></div>
         <div>
             <button id="passwordSubmitBtn" class="menuButton smallButton">Join</button>
             <button id="passwordCancelBtn" class="menuButton secondaryButton smallButton">Cancel</button>
         </div>
    </div>


<script>
(function() { // IIFE

    // --- DOM Elements ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const uiOverlay = document.getElementById('uiOverlay');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const levelDisplay = document.getElementById('levelDisplay');
    const playerListUl = document.getElementById('players');
    const lobbyNameDisplay = document.getElementById('lobbyNameDisplay');

    const usernameScreen = document.getElementById('usernameScreen');
    const usernameInput = document.getElementById('usernameInput');
    const connectBtn = document.getElementById('connectBtn');
    const respawnMessageDiv = document.getElementById('respawnMessage');
    const connectionStatus = document.getElementById('connectionStatus');

    const lobbyBrowserScreen = document.getElementById('lobbyBrowserScreen');
    const lobbyListTableBody = document.getElementById('lobbyListTable').querySelector('tbody');
    const refreshLobbiesBtn = document.getElementById('refreshLobbiesBtn');
    const showCreateLobbyBtn = document.getElementById('showCreateLobbyBtn');
    const lobbyError = document.getElementById('lobbyError');

    const createLobbyScreen = document.getElementById('createLobbyScreen');
    const newLobbyNameInput = document.getElementById('newLobbyNameInput');
    const newLobbyPasswordInput = document.getElementById('newLobbyPasswordInput');
    const createLobbySubmitBtn = document.getElementById('createLobbySubmitBtn');
    const cancelCreateLobbyBtn = document.getElementById('cancelCreateLobbyBtn');
    const createLobbyError = document.getElementById('createLobbyError');

    const passwordPrompt = document.getElementById('passwordPrompt');
    const passwordPromptTitle = document.getElementById('passwordPromptTitle');
    const passwordInput = document.getElementById('passwordInput');
    const passwordSubmitBtn = document.getElementById('passwordSubmitBtn');
    const passwordCancelBtn = document.getElementById('passwordCancelBtn');
    const passwordError = document.getElementById('passwordError');

    const customCursor = document.getElementById('customCursor');

    // --- State Variables ---
    let ws = null;
    let currentScreen = 'username';
    let myPlayerId = null;
    let currentLobbyId = null;
    let currentLobbyName = null;
    let players = {}; // Cache of player data from server
    let obstacles = []; // Cache of obstacle data from server
    let currentLevel = 1;
    let currentScore = 0;
    let inputIntervalId = null;
    let animationFrameId = null;
    let gameActive = false; // Is the rendering loop running?
    let useMouseControl = false;
    const keys = {};
    let clientMousePos = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
    const inputSendInterval = 1000 / 45; // Send input often
    let lastSentInputTime = 0;
    let lobbyToJoin = null; // Temp storage for password prompt

    // --- Utility Functions ---
    function showScreen(screenName) {
        // Hide all screens first
        usernameScreen.classList.add('hidden');
        lobbyBrowserScreen.classList.add('hidden');
        createLobbyScreen.classList.add('hidden');
        uiOverlay.classList.add('hidden'); // In-game UI wrapper
        canvas.style.display = 'none';
        customCursor.style.display = 'none';
        passwordPrompt.style.display = 'none';

        currentScreen = screenName;
        // Clear context-specific errors
        lobbyError.textContent = '';
        createLobbyError.textContent = '';
        passwordError.textContent = '';

        // Show the target screen
        switch (screenName) {
            case 'username':
                usernameScreen.classList.remove('hidden');
                usernameInput.focus();
                break;
            case 'lobbyBrowser':
                lobbyBrowserScreen.classList.remove('hidden');
                sendMessage({ type: 'getLobbies' }); // Refresh list when shown
                break;
            case 'createLobby':
                createLobbyScreen.classList.remove('hidden');
                newLobbyNameInput.focus();
                break;
            case 'inGame':
                uiOverlay.classList.remove('hidden');
                canvas.style.display = 'block'; // <<<< Make visible BEFORE resizing
                resizeCanvas();                 // <<<< Resize AFTER visible
                customCursor.style.display = 'block'; // Show custom cursor
                break;
        }
        // console.log("Debug: Switched to screen:", screenName);
    }

    function sendMessage(data) {
         if (ws && ws.readyState === WebSocket.OPEN) {
             try { ws.send(JSON.stringify(data)); }
             catch (error) { console.error("WS Send Error:", data, error); }
         } else { console.warn("WS not open, cannot send:", data); setStatusMessage("Connection lost.", true); }
    }

    function setStatusMessage(message, isError = false) {
          connectionStatus.textContent = message;
          connectionStatus.style.color = isError ? '#ff4444' : '#aaa';
    }

    // --- Canvas Setup ---
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        // console.log("Debug: Canvas resized to", canvas.width, canvas.height);
    }
    window.addEventListener('resize', () => {
        // Only resize if game is active to avoid issues when canvas is hidden
        if (currentScreen === 'inGame') {
            resizeCanvas();
        }
    });
    // Initial call might not be needed if resize happens in showScreen('inGame')

    // --- WebSocket Connection & Handling ---
    function connectWebSocket(username) {
        respawnMessageDiv.style.display = 'none';
        connectBtn.disabled = true;
        usernameInput.disabled = true;
        setStatusMessage("Connecting...");

        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.hostname}:${window.location.port || (wsProtocol === 'wss:' ? 443 : 80)}`;
        // const wsUrl = `ws://localhost:3000`; // Local

        ws = new WebSocket(wsUrl);
        gameActive = false;

        ws.onopen = () => {
            setStatusMessage("Connected. Loading lobbies...");
            showScreen('lobbyBrowser'); // Go to lobby browser on successful connection
        };

        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                handleServerMessage(data);
            } catch (error) { console.error('WS Message Parse Error:', event.data, error); }
        };

        ws.onerror = (error) => {
            console.error('WebSocket Error:', error);
            if (!gameActive && !respawnMessageDiv.textContent) {
                 setStatusMessage("Connection error. Check server.", true);
            }
            shutdownClient();
        };

        ws.onclose = (event) => {
            console.log(`WebSocket closed. Code: ${event.code}, Reason: ${event.reason}`);
            if (event.code !== 1008 || !respawnMessageDiv.textContent.includes('died recently')) {
                 setStatusMessage("Disconnected.", true);
            }
            shutdownClient();
        };
    }

    function handleServerMessage(data) {
         // console.log("Debug: Received:", data.type, data); // Uncomment for detailed logs
         switch(data.type) {
            case 'lobbyList':
                if(currentScreen === 'lobbyBrowser') { // Only update if viewing
                    populateLobbyList(data.lobbies);
                }
                break;
            case 'joinSuccess':
                console.log(`Joined lobby: ${data.lobbyName} (${data.lobbyId})`);
                currentLobbyId = data.lobbyId;
                currentLobbyName = data.lobbyName;
                lobbyNameDisplay.textContent = `Lobby: ${currentLobbyName}`;
                sendMessage({ type: 'setUsername', username: usernameInput.value.trim() || `Player_${Math.random().toString(16).substring(2, 6)}` });
                showScreen('inGame');
                // Expect 'yourId' and 'gameState' messages next from server
                break;
             case 'createFailed':
                 console.error("Lobby creation failed:", data.reason);
                 if (currentScreen === 'createLobby') createLobbyError.textContent = data.reason || "Failed.";
                 else lobbyError.textContent = data.reason || "Failed.";
                 break;
             case 'joinFailed':
                 console.error("Lobby join failed:", data.reason);
                 if (passwordPrompt.style.display === 'block') passwordError.textContent = data.reason || "Failed.";
                 else lobbyError.textContent = data.reason || "Failed.";
                 lobbyToJoin = null;
                 break;
             case 'passwordRequired':
                  console.log(`Password required for lobby: ${data.lobbyId}`);
                  lobbyToJoin = data.lobbyId;
                  // Find lobby name from potentially existing table row data for better UX
                  const row = lobbyListTableBody.querySelector(`tr[data-lobby-id="${data.lobbyId}"]`);
                  const lname = row ? row.dataset.lobbyName : data.lobbyId;
                  passwordPromptTitle.textContent = `Enter Password for: ${lname}`;
                  passwordInput.value = ''; passwordError.textContent = '';
                  passwordPrompt.style.display = 'block'; passwordInput.focus();
                  break;
             case 'respawnTimeout':
                  console.log(`Respawn timeout: ${data.timeLeft}s left.`);
                  respawnMessageDiv.textContent = `Died recently! Respawn in ${data.timeLeft}s.`;
                  respawnMessageDiv.style.display = 'block';
                  showScreen('username'); // Show prompt screen overlaying the message
                  // Server closes connection, cleanup in onclose
                  break;
             case 'yourId': // Server confirms player ID & initial state
                  myPlayerId = data.id;
                  currentLevel = data.currentLevel || 1;
                  currentScore = data.currentScore || 0;
                  console.log(`Received Player ID: ${myPlayerId}`);
                  if (data.initialState) {
                      players = data.initialState.players || {};
                      obstacles = data.initialState.obstacles || [];
                      console.log("Applied initial game state.");
                  }
                  updateUI();
                  // Start rendering loop and input sending if not already active
                  if (!gameActive) {
                      // console.log("Debug: Starting game loop..."); // Verify loop starts
                      gameActive = true;
                      requestAnimationFrame(gameLoop);
                      canvas.style.cursor = 'none';
                      customCursor.style.display = 'block';
                  }
                  if (!inputIntervalId) {
                      inputIntervalId = setInterval(sendInput, inputSendInterval);
                  }
                  break;
             case 'gameState': // Regular update when in game
                  // console.log("Debug: Received gameState: Players=", Object.keys(data.players || {}).length, "Obstacles=", (data.obstacles || []).length); // Less noisy log
                  if (currentScreen === 'inGame') {
                      players = data.players || {};
                      obstacles = data.obstacles || [];
                      if (data.level !== currentLevel) currentLevel = data.level;
                      if (data.score !== currentScore) currentScore = data.score;
                      updateUI(); // Update score, level, player list
                  }
                  break;
             case 'levelUp':
                  console.log(`Level Up to ${data.newLevel}`);
                  currentLevel = data.newLevel;
                  updateUI(); // Update level display
                  // Add visual effect?
                  break;
             // 'playerLeft' is handled implicitly by gameState not including them anymore
         }
    }

    function shutdownClient() {
         console.log("Shutting down client...");
         gameActive = false; // Stop render loop flag
         if (ws) { ws.onclose = null; ws.onerror = null; ws.onmessage = null; ws.onopen = null; if(ws.readyState < 2) ws.close(); ws = null; } // Check readyState < CLOSING/CLOSED
         if (inputIntervalId) { clearInterval(inputIntervalId); inputIntervalId = null; }
         if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
         myPlayerId = null; currentLobbyId = null; currentLobbyName = null;
         players = {}; obstacles = []; currentLevel = 1; currentScore = 0;
         keys = {}; useMouseControl = false; lobbyToJoin = null;

         showScreen('username'); // Go back to username screen
         canvas.style.cursor = 'default';
         customCursor.style.display = 'none';
         connectBtn.disabled = false;
         usernameInput.disabled = false;
         lobbyListTableBody.innerHTML = '';
         updateUI(); // Clear player list etc.
         // Don't clear respawn message automatically
         setStatusMessage("Disconnected.");
    }

    // --- Lobby Browser Logic ---
    function populateLobbyList(lobbyData) {
        lobbyListTableBody.innerHTML = '';
        if (!lobbyData || lobbyData.length === 0) { // Check length for arrays
             lobbyListTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #aaa;">No lobbies found. Create one!</td></tr>';
             return;
        }
        lobbyError.textContent = '';

        // Use the array directly if server sends array
        lobbyData.sort((a,b) => a.name.localeCompare(b.name)).forEach(lobby => {
             const row = document.createElement('tr');
             row.dataset.lobbyId = lobby.id;
             row.dataset.lobbyName = lobby.name;
             row.dataset.passwordProtected = lobby.passwordProtected;

             const nameCell = document.createElement('td');
             nameCell.textContent = lobby.name;
             if (lobby.passwordProtected) nameCell.classList.add('lobby-passworded');

             const playersCell = document.createElement('td');
             playersCell.textContent = `${lobby.playerCount}`;

             const passwordCell = document.createElement('td');
             passwordCell.textContent = lobby.passwordProtected ? 'Yes' : 'No';

             const actionCell = document.createElement('td');
             const joinBtn = document.createElement('button');
             joinBtn.textContent = 'Join';
             joinBtn.classList.add('menuButton', 'smallButton', 'secondaryButton');
             joinBtn.onclick = (e) => {
                 e.stopPropagation();
                 attemptJoinLobby(lobby.id, lobby.name, lobby.passwordProtected);
             };
             actionCell.appendChild(joinBtn);

             row.appendChild(nameCell); row.appendChild(playersCell);
             row.appendChild(passwordCell); row.appendChild(actionCell);

             row.onclick = () => { // Make row clickable
                 attemptJoinLobby(lobby.id, lobby.name, lobby.passwordProtected);
             };
             lobbyListTableBody.appendChild(row);
         });
    }

    function attemptJoinLobby(lobbyId, lobbyName, isPasswordProtected) {
         lobbyError.textContent = '';
         if (isPasswordProtected) {
              lobbyToJoin = lobbyId;
              passwordPromptTitle.textContent = `Enter Password for: ${lobbyName}`;
              passwordInput.value = ''; passwordError.textContent = '';
              passwordPrompt.style.display = 'block'; passwordInput.focus();
         } else {
             sendMessage({ type: 'joinLobby', lobbyId: lobbyId });
         }
    }

    // --- Input Handling ---
    document.addEventListener('keydown', (e) => {
        const key = e.key.toLowerCase();
        keys[key] = true;
        if (key === 'm' && currentScreen === 'inGame') {
            useMouseControl = !useMouseControl;
            // console.log("Debug: Mouse control:", useMouseControl);
            sendInput(true); // Force send update
        }
    });
    document.addEventListener('keyup', (e) => { keys[e.key.toLowerCase()] = false; });
    canvas.addEventListener('mousemove', (e) => {
        if (currentScreen !== 'inGame') return;
        const rect = canvas.getBoundingClientRect();
        clientMousePos.x = e.clientX - rect.left;
        clientMousePos.y = e.clientY - rect.top;
        customCursor.style.left = `${e.clientX}px`; customCursor.style.top = `${e.clientY}px`;
    });
    canvas.addEventListener('mouseenter', () => { if(currentScreen === 'inGame') customCursor.style.display = 'block'; });
    canvas.addEventListener('mouseleave', () => { if(currentScreen === 'inGame') customCursor.style.display = 'none'; });
    canvas.addEventListener('contextmenu', (e) => e.preventDefault());

    // --- Send Input ---
    function sendInput(forceSend = false) {
        if (!ws || ws.readyState !== WebSocket.OPEN || !myPlayerId || currentScreen !== 'inGame') return;
        const now = Date.now();
        if (!forceSend && now - lastSentInputTime < inputSendInterval * 0.9) return;

        const inputData = { type: 'input', useMouse: useMouseControl };
        if (useMouseControl) { inputData.mousePos = { x: clientMousePos.x, y: clientMousePos.y }; }
        else { const activeKeys = {}; for (const key in keys) { if (keys[key]) activeKeys[key] = true; } inputData.keys = activeKeys; }

        sendMessage(inputData);
        lastSentInputTime = now;
    }

    // --- Drawing & UI Update ---
    function drawPlayer(player) {
        if (!player) return; // Safety
        ctx.save();
        ctx.lineWidth = 1;
        if (!player.isAlive) { ctx.globalAlpha = 0.4; ctx.fillStyle = '#AAAAAA'; ctx.strokeStyle = 'black'; }
        else { ctx.globalAlpha = 1.0; ctx.fillStyle = player.color || 'white'; ctx.strokeStyle = 'black'; }

        ctx.beginPath();
        ctx.arc(player.x, player.y, player.size || 15, 0, Math.PI * 2);
        ctx.fill();

        if (player.id === myPlayerId) { ctx.strokeStyle = 'white'; ctx.lineWidth = 2; }
        ctx.stroke();

        ctx.fillStyle = player.isAlive ? 'white' : '#ddd';
        ctx.font = '12px Segoe UI';
        ctx.textAlign = 'center';
        if (typeof player.x === 'number' && typeof player.y === 'number') {
             ctx.fillText(player.username || `Player ${player.id}`, player.x, player.y - (player.size || 15) - 5);
        }
        ctx.restore();
    }

    function drawObstacle(obstacle) {
         if (!obstacle) return;
         ctx.fillStyle = obstacle.color || '#ff4444';
         ctx.beginPath();
         const radius = (obstacle.size || OBSTACLE_BASE_SIZE) / 2;
         if (typeof obstacle.x === 'number' && typeof obstacle.y === 'number' && radius > 0) {
            ctx.arc(obstacle.x, obstacle.y, radius, 0, Math.PI * 2);
            ctx.fill();
         } else {
             // console.warn("Invalid obstacle data for drawing:", obstacle); // Debug if needed
         }
    }

    function updateUI() {
        if (scoreDisplay) scoreDisplay.textContent = `Score: ${currentScore}`;
        if (levelDisplay) levelDisplay.textContent = `Level: ${currentLevel}`;
        updatePlayerList();
    }

    function updatePlayerList() {
         if (!playerListUl) return;
         playerListUl.innerHTML = '';
         Object.values(players).forEach(player => { // Use local 'players' cache
              if (!player) return;
             const li = document.createElement('li');
             li.style.color = player.color || 'white';
             li.textContent = player.username || `Player ${player.id}`;
             if (!player.isAlive) li.classList.add('dead-player');
             if (player.id === myPlayerId) { li.textContent += ' (You)'; li.style.fontWeight = 'bold'; }
             playerListUl.appendChild(li);
         });
     }

    // --- Game Loop (Rendering) ---
    function gameLoop(timestamp) {
        if (!gameActive || currentScreen !== 'inGame') { animationFrameId = null; return; }
        // console.log("Debug: Render frame tick"); // Uncomment to verify loop runs

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Use the locally cached state
        obstacles.forEach(drawObstacle);
        Object.values(players).forEach(drawPlayer); // Draw based on local 'players' object

        animationFrameId = requestAnimationFrame(gameLoop);
    }

    // --- Event Listeners for Buttons ---
    connectBtn.addEventListener('click', () => {
        const username = usernameInput.value.trim();
        connectWebSocket(username || `Player${Math.floor(Math.random()*1000)}`);
    });
    usernameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') connectBtn.click(); });

    refreshLobbiesBtn.addEventListener('click', () => { lobbyError.textContent = ''; sendMessage({ type: 'getLobbies' }); });
    showCreateLobbyBtn.addEventListener('click', () => { newLobbyNameInput.value = ''; newLobbyPasswordInput.value = ''; createLobbyError.textContent = ''; showScreen('createLobby'); });
    cancelCreateLobbyBtn.addEventListener('click', () => { showScreen('lobbyBrowser'); });
    createLobbySubmitBtn.addEventListener('click', () => {
        const name = newLobbyNameInput.value.trim();
        const pass = newLobbyPasswordInput.value;
        createLobbyError.textContent = '';
        if (!name) { createLobbyError.textContent = 'Lobby name is required.'; return; }
        sendMessage({ type: 'createLobby', lobbyName: name, password: pass || null });
    });

    passwordCancelBtn.addEventListener('click', () => { passwordPrompt.style.display = 'none'; lobbyToJoin = null; });
    passwordSubmitBtn.addEventListener('click', () => {
        if (lobbyToJoin) {
            const pass = passwordInput.value; passwordError.textContent = '';
            sendMessage({ type: 'joinLobby', lobbyId: lobbyToJoin, password: pass });
            passwordPrompt.style.display = 'none'; // Hide while trying
        }
    });
    passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') passwordSubmitBtn.click(); });

    // --- Initial Setup ---
    showScreen('username'); // Start at username screen
    setStatusMessage("Ready to connect."); // Initial status

})(); // End IIFE
</script>
</body>
</html>
