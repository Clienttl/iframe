<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multiplayer Dodge - Lobbies</title>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; overflow: hidden; background: #111; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; }
        canvas { display: none; background: #222; cursor: none; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.95); z-index: 10; text-align: center; padding: 20px; }
        .hidden { display: none !important; } /* Utility class to hide screens */

        /* --- UI Overlay (In-Game) --- */
        #uiOverlay { display: flex; position: absolute; top: 0; left: 0; width: 100%; pointer-events: none; z-index: 5; padding: 15px; justify-content: space-between; align-items: flex-start; }
        #gameInfo { font-size: 20px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; }
        #scoreDisplay, #levelDisplay { margin-bottom: 5px; }
        #playerList { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px; font-size: 14px; max-height: 200px; overflow-y: auto; pointer-events: all; min-width: 150px; }
        #playerList h3 { margin: 0 0 5px 0; font-size: 16px; text-align: center; }
        #playerList ul { list-style: none; padding: 0; margin: 0; }
        #playerList li { margin-bottom: 3px; }
        .dead-player { text-decoration: line-through; color: #aaa; }
        #lobbyNameDisplay { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 5px; font-size: 18px; }

        /* --- Shared Styles --- */
         h2 { font-size: 36px; margin-bottom: 20px; color: #eee; }
        input[type="text"], input[type="password"] { padding: 10px 15px; font-size: 20px; margin-bottom: 15px; width: 280px; text-align: center; border: 2px solid #555; background-color: #333; color: white; border-radius: 5px; }
        .menuButton { padding: 15px 30px; font-size: 24px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 8px; transition: background 0.3s, transform 0.1s; margin-top: 15px; box-shadow: 0 4px #999; min-width: 180px; display: block; margin-left: auto; margin-right: auto;}
        .menuButton:hover:not(:disabled) { background: #45a049; }
        .menuButton:active:not(:disabled) { background-color: #3e8e41; box-shadow: 0 2px #666; transform: translateY(3px); }
        .menuButton:disabled { background-color: #555; color: #aaa; cursor: not-allowed; box-shadow: 0 4px #666;}
        .secondaryButton { background-color: #007bff; }
        .secondaryButton:hover:not(:disabled) { background-color: #0056b3; }
        .secondaryButton:active:not(:disabled) { background-color: #004085; }
        .smallButton { padding: 8px 15px; font-size: 16px; min-width: 100px; margin-top: 10px;}
        .inline-label { display: inline-block; width: 90px; text-align: right; margin-right: 10px; font-size: 16px;}
        .error-message { color: #ff4444; margin-top: 10px; height: 1.2em; font-size: 14px; }
        .info-message { color: #aaa; font-size: 14px; }

        /* --- Username Screen --- */
        #usernameScreen {}
        #mouseToggleInfo { margin-top: 15px; color: #bbb; font-size: 14px;}
        #respawnMessage { background: rgba(200, 0, 0, 0.8); color: white; padding: 15px 20px; border-radius: 8px; font-size: 18px; text-align: center; z-index: 20; display: none; white-space: pre-wrap; max-width: 80%; margin-top: 20px;}


        /* --- Lobby Browser Screen --- */
        #lobbyBrowserScreen { justify-content: flex-start; padding-top: 5vh; }
        #lobbyListContainer { width: 80%; max-width: 700px; height: 60vh; background: rgba(255, 255, 255, 0.05); border-radius: 8px; overflow-y: auto; padding: 15px; margin-bottom: 20px; border: 1px solid #444;}
        #lobbyListTable { width: 100%; border-collapse: collapse; }
        #lobbyListTable th, #lobbyListTable td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #444; }
        #lobbyListTable th { font-size: 16px; color: #ccc; }
        #lobbyListTable tr:last-child td { border-bottom: none; }
        #lobbyListTable tr:hover { background: rgba(255, 255, 255, 0.1); cursor: pointer; }
        .lobby-passworded::after { content: ' ðŸ”’'; color: gold; font-size: 0.8em; vertical-align: middle; }
        #lobbyActions { display: flex; justify-content: center; gap: 20px; margin-top: 10px; }

        /* --- Create Lobby Screen --- */
        #createLobbyScreen { }
        .form-row { margin-bottom: 15px; }

        /* --- Password Prompt --- */
        #passwordPrompt { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(40, 40, 40, 0.98); padding: 30px 40px; border-radius: 10px; z-index: 50; box-shadow: 0 5px 25px rgba(0,0,0,0.5); border: 1px solid #666; display: none; }
        #passwordPrompt h3 { margin: 0 0 20px 0; font-size: 22px; }

        /* --- Custom Cursor --- */
        #customCursor { position: absolute; width: 10px; height: 10px; background: rgba(255, 255, 255, 0.7); border-radius: 50%; border: 1px solid white; pointer-events: none; z-index: 100; transform: translate(-50%, -50%); display: none; }

    </style>
</head>
<body>

    <!-- Screens -->
    <div id="usernameScreen" class="screen">
        <h2>Enter Your Username</h2>
        <input type="text" id="usernameInput" placeholder="Username" maxlength="16">
        <button id="connectBtn" class="menuButton">CONNECT</button>
        <p id="mouseToggleInfo">
            (WASD/Arrows or Mouse to Move)<br/>
            Press 'M' in-game to toggle mouse control.
        </p>
         <div id="respawnMessage"></div> <!-- Message area for timeout -->
         <div id="connectionStatus" class="info-message" style="margin-top: 10px;"></div>
    </div>

    <div id="lobbyBrowserScreen" class="screen hidden">
        <h2>Lobby Browser</h2>
        <div id="lobbyListContainer">
            <table id="lobbyListTable">
                <thead>
                    <tr><th>Name</th><th>Players</th><th>Password</th><th>Action</th></tr>
                </thead>
                <tbody>
                    <!-- Lobby rows injected by JS -->
                </tbody>
            </table>
        </div>
        <div id="lobbyActions">
            <button id="refreshLobbiesBtn" class="menuButton secondaryButton smallButton">Refresh</button>
            <button id="showCreateLobbyBtn" class="menuButton smallButton">Create Lobby</button>
        </div>
         <div id="lobbyError" class="error-message"></div>
    </div>

    <div id="createLobbyScreen" class="screen hidden">
        <h2>Create New Lobby</h2>
        <div class="form-row">
             <label for="newLobbyNameInput" class="inline-label">Lobby Name:</label>
             <input type="text" id="newLobbyNameInput" placeholder="Lobby Name (max 30 chars)" maxlength="30">
        </div>
        <div class="form-row">
             <label for="newLobbyPasswordInput" class="inline-label">Password:</label>
             <input type="password" id="newLobbyPasswordInput" placeholder="(Optional - max 20 chars)" maxlength="20">
        </div>
        <div id="createLobbyError" class="error-message"></div>
        <div>
            <button id="createLobbySubmitBtn" class="menuButton smallButton">Create</button>
            <button id="cancelCreateLobbyBtn" class="menuButton secondaryButton smallButton">Cancel</button>
        </div>
    </div>

    <!-- In-Game UI Elements -->
    <div id="uiOverlay" class="hidden">
         <div id="lobbyNameDisplay">Lobby: ---</div>
        <div id="gameInfo">
            <div id="scoreDisplay">Score: 0</div>
            <div id="levelDisplay">Level: 1</div>
        </div>
        <div id="playerList">
            <h3>Players</h3>
            <ul id="players"></ul>
        </div>
    </div>
    <canvas id="gameCanvas"></canvas>
    <div id="customCursor"></div>

    <!-- Password Prompt Modal -->
    <div id="passwordPrompt">
         <h3 id="passwordPromptTitle">Enter Password for Lobby:</h3>
         <input type="password" id="passwordInput" placeholder="Password">
         <div id="passwordError" class="error-message"></div>
         <div>
             <button id="passwordSubmitBtn" class="menuButton smallButton">Join</button>
             <button id="passwordCancelBtn" class="menuButton secondaryButton smallButton">Cancel</button>
         </div>
    </div>


<script>
(function() { // IIFE

    // --- DOM Elements ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const uiOverlay = document.getElementById('uiOverlay');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const levelDisplay = document.getElementById('levelDisplay');
    const playerListUl = document.getElementById('players');
    const lobbyNameDisplay = document.getElementById('lobbyNameDisplay'); // Added

    const usernameScreen = document.getElementById('usernameScreen');
    const usernameInput = document.getElementById('usernameInput');
    const connectBtn = document.getElementById('connectBtn');
    const respawnMessageDiv = document.getElementById('respawnMessage');
    const connectionStatus = document.getElementById('connectionStatus');

    const lobbyBrowserScreen = document.getElementById('lobbyBrowserScreen');
    const lobbyListTableBody = document.getElementById('lobbyListTable').querySelector('tbody');
    const refreshLobbiesBtn = document.getElementById('refreshLobbiesBtn');
    const showCreateLobbyBtn = document.getElementById('showCreateLobbyBtn');
     const lobbyError = document.getElementById('lobbyError');

    const createLobbyScreen = document.getElementById('createLobbyScreen');
    const newLobbyNameInput = document.getElementById('newLobbyNameInput');
    const newLobbyPasswordInput = document.getElementById('newLobbyPasswordInput');
    const createLobbySubmitBtn = document.getElementById('createLobbySubmitBtn');
    const cancelCreateLobbyBtn = document.getElementById('cancelCreateLobbyBtn');
     const createLobbyError = document.getElementById('createLobbyError');

    const passwordPrompt = document.getElementById('passwordPrompt');
    const passwordPromptTitle = document.getElementById('passwordPromptTitle');
    const passwordInput = document.getElementById('passwordInput');
    const passwordSubmitBtn = document.getElementById('passwordSubmitBtn');
    const passwordCancelBtn = document.getElementById('passwordCancelBtn');
    const passwordError = document.getElementById('passwordError');

    const customCursor = document.getElementById('customCursor');

    // --- State Variables ---
    let ws = null;
    let currentScreen = 'username'; // 'username', 'lobbyBrowser', 'createLobby', 'inGame'
    let myPlayerId = null;
    let currentLobbyId = null;
    let currentLobbyName = null;
    let players = {};
    let obstacles = [];
    let currentLevel = 1;
    let currentScore = 0;
    let inputIntervalId = null;
    let animationFrameId = null;
    let gameActive = false; // Is the game rendering loop running?
    let useMouseControl = false;
    const keys = {};
    let clientMousePos = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
    const inputSendInterval = 1000 / 45;
    let lastSentInputTime = 0;
    let lobbyToJoin = null; // Store lobby ID when prompting for password

    // --- Utility Functions ---
    function showScreen(screenName) {
        usernameScreen.classList.add('hidden');
        lobbyBrowserScreen.classList.add('hidden');
        createLobbyScreen.classList.add('hidden');
        uiOverlay.classList.add('hidden'); // In-game UI
        canvas.style.display = 'none';
        customCursor.style.display = 'none';
        passwordPrompt.style.display = 'none'; // Hide password prompt too

        currentScreen = screenName;
        lobbyError.textContent = ''; // Clear errors on screen change
        createLobbyError.textContent = '';
        passwordError.textContent = '';

        switch (screenName) {
            case 'username':
                usernameScreen.classList.remove('hidden');
                usernameInput.focus();
                break;
            case 'lobbyBrowser':
                lobbyBrowserScreen.classList.remove('hidden');
                // Request fresh lobby list when showing browser
                sendMessage({ type: 'getLobbies' });
                break;
            case 'createLobby':
                createLobbyScreen.classList.remove('hidden');
                newLobbyNameInput.focus();
                break;
            case 'inGame':
                uiOverlay.classList.remove('hidden');
                canvas.style.display = 'block';
                customCursor.style.display = 'block';
                resizeCanvas(); // Ensure canvas size is correct
                break;
        }
        console.log("Switched to screen:", screenName);
    }

     function sendMessage(data) {
         if (ws && ws.readyState === WebSocket.OPEN) {
             try {
                 ws.send(JSON.stringify(data));
             } catch (error) {
                 console.error("Error sending message:", data, error);
             }
         } else {
             console.warn("Cannot send message, WebSocket not open:", data);
             // Optionally try to reconnect or show error
             setStatusMessage("Connection lost. Please reconnect.", true);
         }
     }

     function setStatusMessage(message, isError = false) {
          connectionStatus.textContent = message;
          connectionStatus.style.color = isError ? '#ff4444' : '#aaa';
     }


    // --- WebSocket Connection & Handling ---
    function connectWebSocket(username) {
        respawnMessageDiv.style.display = 'none';
        connectBtn.disabled = true;
        usernameInput.disabled = true;
        setStatusMessage("Connecting...");

        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.hostname}:${window.location.port || (wsProtocol === 'wss:' ? 443 : 80)}`;
        // const wsUrl = `ws://localhost:3000`; // Local

        ws = new WebSocket(wsUrl);
        gameActive = false; // Reset game active flag

        ws.onopen = () => {
            setStatusMessage("Connected. Loading lobbies...");
            // Don't send username yet, wait for lobby join
            showScreen('lobbyBrowser'); // Go straight to lobby browser on connect
        };

        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                handleServerMessage(data); // Process message in a separate function
            } catch (error) {
                console.error('Error processing message:', event.data, error);
            }
        };

        ws.onerror = (error) => {
            console.error('WebSocket Error:', error);
            setStatusMessage("Connection error.", true);
            shutdownClient();
        };

        ws.onclose = (event) => {
            console.log(`WebSocket connection closed. Code: ${event.code}, Reason: ${event.reason}`);
             // Only show generic message if not closed due to respawn timer
            if (event.code !== 1008 || !respawnMessageDiv.textContent.includes('died recently')) {
                 setStatusMessage("Disconnected.", true);
            }
            shutdownClient();
        };
    }

    function handleServerMessage(data) {
         // console.log("Received:", data); // DEBUG: Log all messages
         switch(data.type) {
            case 'lobbyList':
                populateLobbyList(data.lobbies);
                break;
            case 'joinSuccess':
                console.log(`Successfully joined lobby: ${data.lobbyName} (ID: ${data.lobbyId})`);
                currentLobbyId = data.lobbyId;
                currentLobbyName = data.lobbyName;
                lobbyNameDisplay.textContent = `Lobby: ${currentLobbyName}`;
                // Now send username AFTER joining
                sendMessage({ type: 'setUsername', username: usernameInput.value.trim() || `Player...` });
                showScreen('inGame');
                 // Server should send 'yourId' and 'initialState' after successful join
                break;
             case 'createFailed':
                 console.error("Lobby creation failed:", data.reason);
                 if (currentScreen === 'createLobby') {
                     createLobbyError.textContent = data.reason || "Failed to create lobby.";
                 } else {
                     lobbyError.textContent = data.reason || "Failed to create lobby.";
                 }
                 break;
             case 'joinFailed':
                 console.error("Lobby join failed:", data.reason);
                 if (passwordPrompt.style.display === 'block') {
                    passwordError.textContent = data.reason || "Failed to join lobby.";
                 } else {
                     lobbyError.textContent = data.reason || "Failed to join lobby.";
                 }
                 lobbyToJoin = null; // Clear target lobby ID
                 break;
             case 'passwordRequired':
                  console.log(`Password required for lobby: ${data.lobbyId}`);
                  lobbyToJoin = data.lobbyId; // Store the lobby ID we're trying to join
                  const lobbyInfo = lobbyListTableBody.querySelector(`tr[data-lobby-id="${data.lobbyId}"] td:first-child`);
                  passwordPromptTitle.textContent = `Enter Password for Lobby: ${lobbyInfo ? lobbyInfo.textContent : data.lobbyId}`;
                  passwordInput.value = ''; // Clear previous attempts
                  passwordError.textContent = '';
                  passwordPrompt.style.display = 'block';
                  passwordInput.focus();
                  break;
             case 'respawnTimeout':
                  console.log(`Respawn timeout active: ${data.timeLeft}s left.`);
                  respawnMessageDiv.textContent = `You died recently!\nRespawn available in ${data.timeLeft} seconds.`;
                  respawnMessageDiv.style.display = 'block';
                  // Cleanup happens in onclose handler
                  break;
             case 'yourId': // Server confirms player ID and provides initial game state
                  myPlayerId = data.id;
                  currentLevel = data.currentLevel || 1;
                  currentScore = data.currentScore || 0;
                  console.log(`Received my Player ID: ${myPlayerId}`);
                  if (data.initialState) {
                      players = data.initialState.players || {};
                      obstacles = data.initialState.obstacles || [];
                      console.log("Applied initial game state from server.");
                  }
                  updateUI(); // Update score/level displays
                  // Start input sending and rendering loop
                  if (!inputIntervalId) inputIntervalId = setInterval(sendInput, inputSendInterval);
                  if (!gameActive) {
                      gameActive = true;
                      requestAnimationFrame(gameLoop);
                      canvas.style.cursor = 'none';
                      customCursor.style.display = 'block';
                  }
                  break;
             case 'gameState': // Regular in-game state update
                  if (currentScreen === 'inGame') {
                      players = data.players || {};
                      obstacles = data.obstacles || [];
                      if (data.level !== currentLevel) currentLevel = data.level;
                      if (data.score !== currentScore) currentScore = data.score;
                      updateUI();
                  }
                  break;
             case 'levelUp': // Server announced level up
                  console.log(`Server announced Level Up to ${data.newLevel}`);
                  currentLevel = data.newLevel;
                  updateUI();
                  // Add visual effect if desired
                  break;
             // Ignore 'playerLeft' for now, let gameState handle removal visually
         }
    }

    function shutdownClient() {
         console.log("Shutting down client state...");
         gameActive = false;
         if (ws) { ws.onclose = null; ws.onerror = null; ws.onmessage = null; ws.onopen = null; if(ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING) ws.close(); ws = null; }
         if (inputIntervalId) { clearInterval(inputIntervalId); inputIntervalId = null; }
         if (animationFrameId) { cancelAnimationFrame(animationFrameId); animationFrameId = null; }
         myPlayerId = null; currentLobbyId = null; currentLobbyName = null;
         players = {}; obstacles = []; currentLevel = 1; currentScore = 0;
         keys = {}; useMouseControl = false; lobbyToJoin = null;

         // Reset UI
         showScreen('username'); // Go back to username screen
         canvas.style.cursor = 'default';
         customCursor.style.display = 'none';
         connectBtn.disabled = false;
         usernameInput.disabled = false;
         lobbyListTableBody.innerHTML = ''; // Clear lobby list
         updateUI(); // Clear player list etc.
          // Don't clear respawn message - it should persist until next connect attempt
         setStatusMessage("Disconnected.");
    }

    // --- Lobby Browser Logic ---
    function populateLobbyList(lobbyData) {
        lobbyListTableBody.innerHTML = ''; // Clear previous list
        if (!lobbyData || Object.keys(lobbyData).length === 0) {
             lobbyListTableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #aaa;">No lobbies found. Create one!</td></tr>';
             return;
        }
        lobbyError.textContent = ''; // Clear errors

        Object.values(lobbyData).sort((a,b) => a.name.localeCompare(b.name)).forEach(lobby => {
             const row = document.createElement('tr');
             row.dataset.lobbyId = lobby.id;
             row.dataset.lobbyName = lobby.name; // Store name for prompts
             row.dataset.passwordProtected = lobby.passwordProtected;

             const nameCell = document.createElement('td');
             nameCell.textContent = lobby.name;
             if (lobby.passwordProtected) {
                 nameCell.classList.add('lobby-passworded');
             }

             const playersCell = document.createElement('td');
             playersCell.textContent = `${lobby.playerCount}`; // Add max players later if needed

             const passwordCell = document.createElement('td');
             passwordCell.textContent = lobby.passwordProtected ? 'Yes' : 'No';

             const actionCell = document.createElement('td');
             const joinBtn = document.createElement('button');
             joinBtn.textContent = 'Join';
             joinBtn.classList.add('menuButton', 'smallButton', 'secondaryButton');
             joinBtn.onclick = (e) => {
                 e.stopPropagation(); // Prevent row click if button is clicked
                 attemptJoinLobby(lobby.id, lobby.name, lobby.passwordProtected);
             };
             actionCell.appendChild(joinBtn);

             row.appendChild(nameCell);
             row.appendChild(playersCell);
             row.appendChild(passwordCell);
             row.appendChild(actionCell);

             // Make row clickable too
             row.onclick = () => {
                 attemptJoinLobby(lobby.id, lobby.name, lobby.passwordProtected);
             };

             lobbyListTableBody.appendChild(row);
         });
    }

    function attemptJoinLobby(lobbyId, lobbyName, isPasswordProtected) {
         lobbyError.textContent = ''; // Clear previous errors
         if (isPasswordProtected) {
              lobbyToJoin = lobbyId; // Store the lobby ID we're trying to join
              passwordPromptTitle.textContent = `Enter Password for Lobby: ${lobbyName}`;
              passwordInput.value = '';
              passwordError.textContent = '';
              passwordPrompt.style.display = 'block';
              passwordInput.focus();
         } else {
             // Join directly if no password
             sendMessage({ type: 'joinLobby', lobbyId: lobbyId });
         }
    }

    // --- Input Handling ---
    document.addEventListener('keydown', (e) => {
        const key = e.key.toLowerCase();
        keys[key] = true;
        // Toggle Mouse Control only when in game
        if (key === 'm' && currentScreen === 'inGame') {
            useMouseControl = !useMouseControl;
            console.log("Mouse control toggled:", useMouseControl);
            sendInput(true); // Force send immediate update
        }
    });
    document.addEventListener('keyup', (e) => { keys[e.key.toLowerCase()] = false; });
    canvas.addEventListener('mousemove', (e) => {
        if (currentScreen !== 'inGame') return;
        const rect = canvas.getBoundingClientRect();
        clientMousePos.x = e.clientX - rect.left;
        clientMousePos.y = e.clientY - rect.top;
        customCursor.style.left = `${e.clientX}px`; customCursor.style.top = `${e.clientY}px`;
    });
    canvas.addEventListener('mouseenter', () => { if(currentScreen === 'inGame') customCursor.style.display = 'block'; });
    canvas.addEventListener('mouseleave', () => { if(currentScreen === 'inGame') customCursor.style.display = 'none'; });
    canvas.addEventListener('contextmenu', (e) => e.preventDefault());

    // --- Send Input ---
    function sendInput(forceSend = false) {
        if (!ws || ws.readyState !== WebSocket.OPEN || !myPlayerId || currentScreen !== 'inGame') return;
        const now = Date.now();
        if (!forceSend && now - lastSentInputTime < inputSendInterval * 0.9) return;

        const inputData = { type: 'input', useMouse: useMouseControl };
        if (useMouseControl) { inputData.mousePos = { x: clientMousePos.x, y: clientMousePos.y }; }
        else { const activeKeys = {}; for (const key in keys) { if (keys[key]) activeKeys[key] = true; } inputData.keys = activeKeys; }

        sendMessage(inputData); // Use helper function
        lastSentInputTime = now;
    }

    // --- Drawing & UI Update --- (Mostly unchanged from previous version)
    function drawPlayer(player) { /* ... Same as before ... */ }
    function drawObstacle(obstacle) { /* ... Same as before ... */ }
    function updateUI() {
        if (scoreDisplay) scoreDisplay.textContent = `Score: ${currentScore}`;
        if (levelDisplay) levelDisplay.textContent = `Level: ${currentLevel}`;
        updatePlayerList();
    }
    function updatePlayerList() { /* ... Same as before ... */ }

    // --- Game Loop (Rendering) ---
    function gameLoop(timestamp) {
        if (!gameActive || currentScreen !== 'inGame') { animationFrameId = null; return; }
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        obstacles.forEach(drawObstacle);
        Object.values(players).forEach(drawPlayer);
        animationFrameId = requestAnimationFrame(gameLoop);
    }

    // --- Event Listeners for Buttons ---
    connectBtn.addEventListener('click', () => {
        const username = usernameInput.value.trim();
        // Username is set AFTER joining lobby now
        connectWebSocket(username || `Player${Math.floor(Math.random()*1000)}`);
    });
    usernameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') connectBtn.click(); });

    refreshLobbiesBtn.addEventListener('click', () => {
         lobbyError.textContent = '';
         sendMessage({ type: 'getLobbies' });
    });
    showCreateLobbyBtn.addEventListener('click', () => {
         newLobbyNameInput.value = '';
         newLobbyPasswordInput.value = '';
         createLobbyError.textContent = '';
         showScreen('createLobby');
    });
    cancelCreateLobbyBtn.addEventListener('click', () => { showScreen('lobbyBrowser'); });
    createLobbySubmitBtn.addEventListener('click', () => {
        const name = newLobbyNameInput.value.trim();
        const pass = newLobbyPasswordInput.value; // Don't trim password
        createLobbyError.textContent = ''; // Clear previous errors
        if (!name) {
             createLobbyError.textContent = 'Lobby name is required.';
             return;
        }
        sendMessage({ type: 'createLobby', lobbyName: name, password: pass || null });
         // Stay on this screen, wait for joinSuccess or createFailed message
    });

    passwordCancelBtn.addEventListener('click', () => {
        passwordPrompt.style.display = 'none';
        lobbyToJoin = null; // Clear target lobby ID
    });
    passwordSubmitBtn.addEventListener('click', () => {
        if (lobbyToJoin) {
            const pass = passwordInput.value;
            passwordError.textContent = ''; // Clear previous errors
            sendMessage({ type: 'joinLobby', lobbyId: lobbyToJoin, password: pass });
            passwordPrompt.style.display = 'none'; // Hide prompt while trying
        }
    });
     passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') passwordSubmitBtn.click(); });

    // --- Initial Setup ---
    showScreen('username'); // Start at username screen
    // resizeCanvas called inside showScreen('inGame') when needed

})(); // End IIFE
</script>
</body>
</html>
